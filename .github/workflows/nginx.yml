name: Build Nginx for Debian

on:
  push:
    tags:
      - "v*"
    branches: [ master ]
  # pull_request:
    # branches: [ master ]

jobs:
  build-nginx-openssl:
    runs-on: ubuntu-latest
    env:
      Dir: nginx-build
    steps:
    - uses: actions/checkout@v2
    - name: Set up Clang
      uses: egor-tensin/setup-clang@v1
      with:
        version: 15
    # https://github.com/actions/runner-images/issues/6153
    - name: runner deps fixes
      run: sudo apt-get remove nginx libgd3
    - name: Set up packages
      run: sudo apt-get install -y unzip curl gawk wget git perl debhelper cmake pkg-config nasm libpam-dev
    - name: Set up deps
      run: sudo bash ./.github/nginx-package-build/get-deps.sh
    - name: Pack
      run: bash ./.github/nginx-package-build/pack.sh $Dir
    - name: Show Info
      run: bash ./.github/nginx-package-build/show-info.sh $Dir
    - name: Find artifact
      run: |
        FILE=$(find ./$Dir -name "*.deb" -type f) && echo $FILE
        echo "Artifact=$FILE" >> $GITHUB_ENV
    - name: Upload Binaries
      uses: actions/upload-artifact@v3
      with:
        name: nginx-openssl-${{ github.sha }}.zip
        path: ${{ env.Artifact }}
    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: ${{ env.Artifact }}
  build-nginx-boringssl:
    runs-on: ubuntu-latest
    env:
      Dir: nginx-build-with-boringssl
    steps:
    - uses: actions/checkout@v2
    - name: Set up Golang
      uses: actions/setup-go@v2
      with:
        go-version: '1.20.5'
    - name: Set up Clang
      uses: egor-tensin/setup-clang@v1
      with:
        version: 15
    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
    # - name: Set up packages
    #   run: sudo apt-get install -y unzip curl gawk wget git perl libexpat-dev libpcre3-dev libxml2-dev libxslt-dev libgeoip-dev libgd-dev libpam0g-dev libperl-dev libmaxminddb-dev uuid-dev debhelper cmake libunwind-dev
    # https://github.com/actions/runner-images/issues/6153
    - name: runner deps fixes
      run: sudo apt-get remove nginx libgd3
    - name: Set up packages
      run: sudo apt-get install -y unzip curl gawk wget git perl debhelper cmake pkg-config nasm libpam-dev
    - name: Set up deps
      run: sudo bash ./.github/nginx-package-build/get-deps.sh
    - name: Pack
      run: bash ./.github/nginx-package-build/pack.sh $Dir
    - name: Show Info
      run: bash ./.github/nginx-package-build/show-info.sh $Dir
    - name: Find artifact
      run: |
        FILE=$(find ./$Dir -name "*.deb" -type f) && echo $FILE
        echo "Artifact=$FILE" >> $GITHUB_ENV
    - name: Upload Binaries
      uses: actions/upload-artifact@v3
      with:
        name: nginx-boringssl-${{ github.sha }}.zip
        path: ${{ env.Artifact }}
    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: ${{ env.Artifact }}
